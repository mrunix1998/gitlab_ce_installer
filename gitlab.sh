#! /bin/bash

# Gitbub : https://github.com/mrunix1998
# Email : salehimohammad331@gmail.com
# License : GPL v2.0
# Last update : 15-March-2021_09:13:05
# elk.installer v1.0.1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
# SUCCESSFULLY TESTED IN UBUNTU 20.04 [FOCAL]
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# PRINT MSG TO TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
clear
echo -e "[>>] --------------------------------------------------[<<]"
echo -e "* Gitbub : https://github.com/mrunix1998                   "
echo -e "* Email : salehimohammad331@gmail.com                         "
echo -e "-----------------------------------------------------------"
echo -e "* INSTALL LOCAL GITLAB_CE SELF MANAGED                     " 
echo -e "[>>] ---------------- -------------------------------- [<<]"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



function check {
    # CHECK CONFIGURATION FILE # -------------------------------------------------------------------------------------------------------------------------- #
    [ ! -f gitlab.conf ] && echo -e "\e[91m [>>] cannot access 'gitlab.conf': No such file or directory \e[0m" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # LOAD VARIABLE FROM CONFIGURATION FILE # ------------------------------------------------------------------------------------------------------------- #
    source gitlab.conf
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK CONFIGURATION VARIABLES # --------------------------------------------------------------------------------------------------------------------- #
    [ -z "$proxy_address" ] && echo "\e[91m [>>] proxy_address VARIABLE IS EMPTY \e[0m"         && exit 1
    [ -z "$external_url" ]    && echo "\e[91m [>>] external_url VARIABLE IS EMPTY \e[0m"        && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}

check

# UPDATE AND UPGRADE SYSTEM # ----------------------------------------------------------------------------------------------------------------------------- #
echo -e "Updating system"
apt-get update
apt-get -y dist-upgrade
apt -y autoremove
apt-get -y -f install
apt-get clean
apt-get install -y net-tools curl wget ca-certificates curl openssh-server postfix
apt-get install -y lsb-release &> /dev/null
clear
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


# CHECK lsb_release # ------------------------------------------------------------------------------------------------------------------------------------- #
which lsb_release &> /dev/null
[ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT FIND lsb_release COMMAND\e[0m" && exit !
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



# CHECK OS RELIABILITY # ------------------------------------------------------------------------------------------------------------------------------------- #
lsb_release -cs | grep 'focal' &> /dev/null
[ "$?" != "0" ] && echo -e "\e[91m[>] WE CAN NOT INSTALL NETDATA IN YOUR OS\e[0m"
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #

# ADD SHECAN DNS SERVER IN SYSTEM # ----------------------------------------------------------------------------------------------------------------------- #
echo -e "nameserver 185.51.200.2\nnameserver 178.22.122.100" > /etc/resolv.conf
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #

# SHOW WELLCOMMING MESSAGE
echo -e "Hello $USER\n This is Gitlab_CE installer " | cowsay -f tux
# ----------------------------------------------------------------------------------------------------------------------------------------------------------#

# DOWNLOAD INSTALLER FROM GITLAB REPOSITORY
cd /tmp ; curl -LO $proxy_address
# ----------------------------------------------------------------------------------------------------------------------------------------------------------#

# RUN THE INSTALLER
bash /tmp/script.deb.sh
# ----------------------------------------------------------------------------------------------------------------------------------------------------------#

# INSTALL GITLAB_CE 
sudo EXTERNAL_URL=$external_url apt install gitlab-ce
# ----------------------------------------------------------------------------------------------------------------------------------------------------------#

function check_ufw_status {
    sudo ufw status | grep -qw active
    if [[ "$?" =  1 ]]; then
        echo -e "ufw service is down "
    else
        echo -e "ufw is updating ... "
        sudo ufw allow http
        sudo ufw allow https
        sudo ufw allow OpenSSH
        echo -e "ufw updated :D"
    fi
}
